/*
Copyright (c) 2022 Rune AI Inc.
All rights reserved.

This code is proprietary to Rune AI Inc.
The code may be used solely for accessing the Service provided by Rune AI Inc. following the Rune Terms of Service ("Terms") accessible at rune.ai/eula. You may not use this code for any use or purpose other than as expressly permitted by the Terms.
Restrictions set forth in the Terms include, but is not limited to, that you may not copy, adapt, modify, prepare derivative works based upon, distribute, license, sell, transfer, publicly display, publicly perform, transmit, stream, broadcast, attempt to discover any source code, reverse engineer, decompile, dissemble, or otherwise exploit the code as a whole or any portion of the code.
*/
"use strict";var e=require("xstate"),t=require("rune-msgpack"),n=require("base-64");function r(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var o=r(t),a=r(n);var c=function(e){for(var t=[],n=0,r=e.length;n<r;n++)t.push(String.fromCharCode(e[n]));return a.encode(t.join(""))},s=function(e){return e.charCodeAt(0)},i=function(e){return Uint8Array.from(a.decode(e),s)};function E(e){return"".concat("RUNE_MSG_V2;").concat((t=e,void 0===n&&(n={}),c(o.encode(t,{maxDepth:null!==(r=n.maxDepth)&&void 0!==r?r:10,sortKeys:null===(a=n.sortKeys)||void 0===a||a}))));var t,n,r,a}function u(e,t){return function(e){return"string"==typeof e&&e.startsWith("RUNE_MSG_V2;")}(e)&&function(e){return t=e.slice("RUNE_MSG_V2;".length),o.decode(i(t));var t}(e)[t]||null}function T(e){return E({runeGameCommand:e})}exports.createGameClient=function(t){var n=t.network,r=t.onGameToClientPayload,o=t.onGameStateChanged,a=function(t){var n=t.onRequestStateSync,r=e.createMachine({tsTypes:{},preserveActionOrder:!0,id:"CLIENT_STATE (v5)",initial:"NOT_READY",states:{NOT_READY:{initial:"LOADING",states:{LOADING:{on:{onInit:{target:"WAITING_FOR_STATE_SYNC"}}},WAITING_FOR_STATE_SYNC:{entry:"REQUEST_STATE_SYNC",on:{onStateSync:{target:"WAITING_FOR_ON_CHANGE"}}},DISCONNECTED:{on:{onReconnected:{target:"WAITING_FOR_STATE_SYNC"}}},ERR:{},WAITING_FOR_ON_CHANGE:{on:{onChange:{target:"#CLIENT_STATE (v5).READY"}}}}},READY:{initial:"PLAYING",states:{PLAYING:{on:{onGameOver:{target:"GAME_OVER"},onStateSync:{}}},GAME_OVER:{on:{onStateSync:{target:"PLAYING"}}}},on:{onDisconnected:{target:"#CLIENT_STATE (v5).NOT_READY.DISCONNECTED"}}}},on:{onError:{target:".NOT_READY.ERR"},onGameReloaded:{target:".NOT_READY.LOADING"}},schema:{context:{},events:{}},context:{}},{actions:{REQUEST_STATE_SYNC:n}}),o=e.interpret(r);return o.start(),o}({onRequestStateSync:function(){n.sendMsgToServer(E({gameToServer:"REQUEST_STATE_SYNC"}))}});a.onTransition((function(e,t){if(e.changed){if(e.matches("NOT_READY.DISCONNECTED")&&n.sendMsgToGame(T({type:"DISCONNECTED"})),e.matches("NOT_READY.ERR"))return o({state:"ERR"});if(e.matches("NOT_READY"))return o({state:"LOADING"});if(e.matches("READY.PLAYING"))return o({state:"PLAYING"});if(e.matches("READY.GAME_OVER")&&"onGameOver"===t.type)return o({state:"GAME_OVER",context:t.context});throw new Error("State machine is in unexpected state: ".concat(e.value))}}));var c={onServerMsg:function(e){var t=u(e,"serverToGame");t&&("event"in t&&"stateSync"===t.event&&a.send("onStateSync"),(a.state.matches("READY")||a.state.matches("NOT_READY.WAITING_FOR_ON_CHANGE"))&&n.sendMsgToGame(e))},onGameMsg:function(e){var t=u(e,"runeGameEvent");if(t)return"INIT"===t.type&&a.send("onInit"),"ON_CHANGE"===t.type?void a.send("onChange"):("GAME_OVER"===t.type&&a.send({type:"onGameOver",context:t.context}),"ERR"===t.type&&a.send("onError"),void r(t));var o=function(e){return u(e,"gameToServer")}(e);o&&n.sendMsgToServer(e)},onDisconnected:function(){a.send("onDisconnected")},onReconnected:function(){a.send("onReconnected")},onGameReloaded:function(){a.send("onGameReloaded")},sendMsgToGame:function(e){n.sendMsgToGame(T(e))}};return o({state:"LOADING"}),c};
